// tests/basics/nested_flow.vx
// Test deeply nested control flow

import "io.vx" as io;

extern func exit(i32 code) -> void;

func main() -> i32 {
    io.println("Running nested flow tests...");

    // 1. Deeply nested IF
    var i32 i = 0;
    if (true) {
        i = i + 1;
        if (true) {
            i = i + 1;
            if (true) {
                i = i + 1;
                if (true) {
                    i = i + 1;
                    if (true) {
                        i = i + 1;
                        if (true) {
                            i = i + 1;
                            if (false) {
                                i = 0;
                            } else {
                                i = i + 1;
                            }
                        }
                    }
                }
            }
        }
    }
    
    // i should be 7
    if (i != 7) {
        io.println("FAIL: Nested IF failed");
        exit(1);
    }
    
    // 2. Nested Loops (3D Matrix iteration simulation)
    var i32 sum = 0;
    var i32 x = 0;
    while (x < 5) {
        var i32 y = 0;
        while (y < 5) {
            var i32 z = 0;
            while (z < 5) {
                sum = sum + 1;
                z = z + 1;
            }
            y = y + 1;
        }
        x = x + 1;
    }
    
    // 5 * 5 * 5 = 125
    if (sum != 125) {
        io.println("FAIL: Nested While loop failed");
        exit(1);
    }
    
    // 3. Mixed Looping and Break/Continue
    // Find first number divisible by 7 in range, skip evens
    var i32 found = 0;
    var i32 j = 0;
    
    while (j < 100) {
        j = j + 1;
        
        if (j % 2 == 0) {
            continue;
        }
        
        // Nested loop logic
        var i32 k = 0;
        k = 0; // Reset
        while (k < 5) {
            if (j == 21 && k == 2) {
                found = j;
                // We want to break outer loop ideally, but Virex only supports single break?
                // Assuming break exits inner loop.
                break;
            }
            k = k + 1;
        }
        
        if (found != 0) {
            break; // Break outer
        }
    }
    
    if (found != 21) {
        io.println("FAIL: Nested break/continue failed");
        exit(1);
    }
    
    io.println("PASS: Nested flow tests passed");
    return 0;
}
